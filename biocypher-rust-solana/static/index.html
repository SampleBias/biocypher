<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bi0cyph3r — DNA Cryptography</title>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --accent: #58a6ff;
      --success: #3fb950;
      --warning: #d29922;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 2rem;
      min-height: 100vh;
    }
    .container { max-width: 640px; margin: 0 auto; }
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--accent);
    }
    .subtitle { opacity: 0.7; font-size: 0.9rem; margin-bottom: 2rem; }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; }
    input, textarea, select {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.9rem;
    }
    textarea { min-height: 100px; resize: vertical; }
    button {
      background: var(--accent);
      color: var(--bg);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .output {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 6px;
      font-size: 0.85rem;
      word-break: break-all;
      white-space: pre-wrap;
    }
    .error { color: #f85149; }
    .success { color: var(--success); }
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .tab {
      padding: 0.5rem 1rem;
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
    }
    .tab.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .password-row { margin-top: 1rem; }
    .stats { font-size: 0.8rem; opacity: 0.8; margin-top: 0.5rem; }
    .arcium-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .toggle-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .toggle {
      width: 44px;
      height: 24px;
      background: var(--border);
      border-radius: 12px;
      cursor: pointer;
      position: relative;
      transition: background 0.2s;
    }
    .toggle.on { background: var(--success); }
    .toggle::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: var(--text);
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: left 0.2s;
    }
    .toggle.on::after { left: 22px; }
    .toggle-label { font-size: 0.85rem; }
    .arcium-status {
      font-size: 0.8rem;
      opacity: 0.9;
    }
    .arcium-status.ready { color: var(--success); }
    .arcium-status.loading { color: var(--warning); }
    .arcium-status.error { color: #f85149; }
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .plasmid-viewer-wrap {
      margin-top: 1rem;
      min-height: 400px;
      background: var(--bg);
      border-radius: 6px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .plasmid-viewer-wrap.hidden { display: none; }
    .export-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .export-row.hidden { display: none; }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }
    .checkbox-row input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }
    .expression-options { margin-top: 0.5rem; margin-left: 1rem; }
    .plasmid-transmit-wrap {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    .plasmid-transmit-wrap.hidden { display: none; }
    .plasmid-transmit-wrap label { margin-top: 0.75rem; }
    .plasmid-transmit-wrap label:first-of-type { margin-top: 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Bi0cyph3r</h1>
    <p class="subtitle">DNA cryptography — encode and decode messages as DNA sequences · <a href="offline.html" style="color:var(--accent)">Offline (no server) — Basic + Plasmid</a></p>

    <div class="card">
      <div class="arcium-row">
        <div class="toggle-wrap">
          <div id="arciumToggle" class="toggle" title="Use Arcium MPC for secure encryption"></div>
          <span class="toggle-label">Arcium MPC</span>
        </div>
        <span id="arciumStatus" class="arcium-status">Off — local encoding</span>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="encode">Encode</button>
        <button class="tab" data-tab="decode">Decode</button>
        <button class="tab" data-tab="safety">Safety Screen</button>
        <button class="tab" data-tab="plasmid">Plasmid</button>
      </div>

      <div id="encode" class="tab-content active">
        <label>Message</label>
        <textarea id="encodeInput" placeholder="Enter message to encode..."></textarea>
        <label>Mode</label>
        <select id="encodeMode">
          <option value="basic">Basic</option>
          <option value="nanopore">Nanopore</option>
          <option value="secure">Secure (password)</option>
          <option value="splitkey">Split Key</option>
        </select>
        <div id="encodePassword" class="password-row" style="display:none">
          <label>Password</label>
          <input type="password" id="encodePass" placeholder="Required for secure mode">
        </div>
        <div id="encodeSplitKeyInfo" class="password-row" style="display:none">
          <p style="font-size:0.85rem;opacity:0.9">Split Key: K1 (you keep) + K2 (escrow). Manufacturer gets ciphertext-as-DNA only.</p>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" id="encodeStoreOnChain">
          <label for="encodeStoreOnChain" style="margin-bottom:0">Store attestation on Solana</label>
        </div>
        <button id="encodeBtn" style="margin-top:1rem">Encode</button>
        <div id="encodeOutput" class="output" style="display:none"></div>
      </div>

      <div id="decode" class="tab-content">
        <label>DNA Sequence</label>
        <textarea id="decodeInput" placeholder="ATCGATCG..."></textarea>
        <div class="checkbox-row">
          <input type="checkbox" id="decodeExtractPayload">
          <label for="decodeExtractPayload" style="margin-bottom:0">Extract payload from plasmid (between markers)</label>
        </div>
        <label>Mode</label>
        <select id="decodeMode">
          <option value="basic">Basic</option>
          <option value="nanopore">Nanopore</option>
          <option value="secure">Secure (password)</option>
          <option value="splitkey">Split Key</option>
        </select>
        <div id="decodePassword" class="password-row" style="display:none">
          <label>Password</label>
          <input type="password" id="decodePass" placeholder="Required for secure mode">
        </div>
        <div id="decodeSplitKeyWrap" class="password-row" style="display:none">
          <label>K1 (base64)</label>
          <textarea id="decodeK1" placeholder="Paste K1 or load from file" rows="2"></textarea>
          <label style="margin-top:0.5rem">K2 source</label>
          <select id="decodeK2Source">
            <option value="paste">Paste K2</option>
            <option value="escrow">Fetch from escrow</option>
          </select>
          <div id="decodeK2Paste" style="margin-top:0.5rem">
            <label>K2 (base64)</label>
            <textarea id="decodeK2" placeholder="Paste K2" rows="2"></textarea>
          </div>
          <div id="decodeK2Escrow" style="margin-top:0.5rem;display:none">
            <label>Transmission ID</label>
            <input type="text" id="decodeTransmissionId" placeholder="Transmission ID from encode">
          </div>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" id="decodeOnChain">
          <label for="decodeOnChain" style="margin-bottom:0">Record decode on Solana</label>
        </div>
        <button id="decodeBtn" style="margin-top:1rem">Decode</button>
        <div id="decodeOutput" class="output" style="display:none"></div>
      </div>

      <div id="safety" class="tab-content">
        <label>DNA Sequence</label>
        <textarea id="safetyInput" placeholder="ATCGATCG..."></textarea>
        <div class="checkbox-row">
          <input type="checkbox" id="safetyVerifyOnChain">
          <label for="safetyVerifyOnChain" style="margin-bottom:0">Verify on Solana</label>
        </div>
        <button id="safetyBtn" style="margin-top:1rem">Screen</button>
        <div id="safetyOutput" class="output" style="display:none"></div>
      </div>

      <div id="plasmid" class="tab-content">
        <label>Message</label>
        <textarea id="plasmidInput" placeholder="Enter message to encode into DNA..."></textarea>
        <label>Encoding mode</label>
        <select id="plasmidMode">
          <option value="basic">Basic</option>
          <option value="nanopore">Nanopore</option>
          <option value="secure">Secure (password)</option>
          <option value="splitkey">Split Key</option>
        </select>
        <div id="plasmidPassword" class="password-row" style="display:none">
          <label>Password</label>
          <input type="password" id="plasmidPass" placeholder="Required for secure mode">
        </div>
        <div id="plasmidSplitKeyInfo" class="password-row" style="display:none">
          <p style="font-size:0.85rem;opacity:0.9">Split Key: Save K1, escrow K2. Transmit sends sequence directly (manufacturer has no key).</p>
        </div>
        <label>Plasmid name</label>
        <input type="text" id="plasmidName" placeholder="biocypher_plasmid" value="biocypher_plasmid">
        <div class="checkbox-row">
          <input type="checkbox" id="plasmidExpressionMode">
          <label for="plasmidExpressionMode" style="margin-bottom:0">Expression mode</label>
        </div>
        <div id="plasmidExpressionOptions" class="expression-options" style="display:none">
          <div class="checkbox-row">
            <input type="checkbox" id="plasmidFluorescence" checked>
            <label for="plasmidFluorescence" style="margin-bottom:0">Include fluorescence (eGFP)</label>
          </div>
          <div class="checkbox-row">
            <input type="checkbox" id="plasmidMarkers" checked disabled>
            <label for="plasmidMarkers" style="margin-bottom:0;opacity:0.8">Include decoding markers</label>
          </div>
        </div>
        <button id="plasmidBtn" style="margin-top:1rem">Design Plasmid</button>
        <div id="plasmidOutput" class="output" style="display:none"></div>
        <div id="plasmidViewerWrap" class="plasmid-viewer-wrap hidden">
          <div id="plasmidViewer" style="height:400px"></div>
        </div>
        <div id="plasmidExportRow" class="export-row hidden">
          <button id="exportFastaBtn">Export FASTA</button>
          <button id="exportTxtBtn">Export TXT</button>
          <button id="exportInstructionsBtn">Export Instructions</button>
          <button id="screenPlasmidBtn">Screen plasmid</button>
          <button id="transmitBtn" title="Requires Arcium MPC">Transmit to Manufacturer</button>
        </div>
        <div id="plasmidTransmitWrap" class="plasmid-transmit-wrap hidden">
          <div id="transmitSecureWrap">
            <label>Transmission password</label>
            <input type="password" id="transmitPassword" placeholder="Share with manufacturer for decryption">
          </div>
          <div id="transmitSplitKeyNote" style="display:none">
            <p style="font-size:0.85rem;opacity:0.9">Sequence sent directly. Manufacturer synthesizes DNA (ciphertext); they have no key.</p>
          </div>
          <label>Manufacturer API URL</label>
          <input type="text" id="transmitManufacturerUrl" placeholder="https://api.example.com/orders (optional)">
          <button id="transmitConfirmBtn">Send transmission</button>
          <div id="transmitOutput" class="output" style="display:none"></div>
        </div>
        <div id="plasmidSplitKeyActions" class="export-row hidden" style="margin-top:0.5rem">
          <button id="saveK1Btn">Save K1</button>
          <button id="escrowK2Btn">Escrow K2</button>
        </div>
      </div>
    </div>

    <p class="subtitle">API: <code id="apiUrl">http://127.0.0.1:8080</code></p>
  </div>

  <script src="https://unpkg.com/seqviz@3/dist/seqviz.min.js"></script>
  <script>
    const API = 'http://127.0.0.1:8080';

    const PLASMID_PARTS = {
      markerStart: 'CCTAGGGATCCATGCCTAG',
      markerEnd: 'CCTAGGCATGGATCCCTAGG',
      promoter: 'taatacgactcactatagggaga',
      rbs: 'aggagga',
      terminator: 'ctagcataaccccttggggcctctaaacgggtcttgaggggttttttg',
      egfp: 'atgcgtaaaggagaagaacttttcactggagttgtcccaattcttgttgaattagatggtgatgttaatgggcacaaattttctgtcagtggagagggtgaaggtgatgcaacatacggaaaacttacccttaaatttatttgcactactggaaaactacctgttccatggccaacacttgtcactactttcggttatggtgttcaatgctttgcgagatacccagatcatatgaaacagcatgactttttcaagagtgccatgcccgaaggttatgtacaggaaagaactatatttttcaaagatgacgggaactacaagacacgtgctgaagtcaagtttgaaggtgatacccttgttaatagaatcgagttaaaaggtattgattttaaagaagatggaaacattcttggacacaaattggaatacaactataactcacacaatgtatacatcatggcagacaaacaaaagaatggaatcaaagttaacttcaaaattagacacaacattgaagatggaagcgttcaactagcagaccattatcaacaaaatactccaattggcgatggccctgtccttttaccagacaaccattacctgtccacacaatctgccctttcgaaagatcccaacgaaaagagagaccacatggtccttcttgagtttgtaacagctgctgggattacacatggcatggatgaactatacaaataataa'
    };
    let ARCIUM_URL = 'http://127.0.0.1:3001';
    let arciumOn = false;
    let arciumReady = false;

    async function fetchArciumInfo() {
      try {
        const r = await fetch(API + '/api/arcium-info');
        const j = await r.json();
        if (j.service_url) ARCIUM_URL = j.service_url.replace(/\/$/, '');
      } catch (_) {}
    }

    async function checkArciumStatus() {
      const statusEl = document.getElementById('arciumStatus');
      statusEl.className = 'arcium-status loading';
      statusEl.innerHTML = '<span class="spinner"></span> Connecting…';
      try {
        const r = await fetch(ARCIUM_URL + '/status');
        const j = await r.json();
        if (r.ok && j.arcium === 'ready') {
          arciumReady = true;
          statusEl.className = 'arcium-status ready';
          statusEl.textContent = 'Connected — secure encryption';
        } else {
          arciumReady = false;
          statusEl.className = 'arcium-status error';
          statusEl.textContent = j.error || 'Not ready';
        }
      } catch (e) {
        arciumReady = false;
        statusEl.className = 'arcium-status error';
        statusEl.textContent = 'Arcium service not running';
      }
    }

    document.getElementById('arciumToggle').addEventListener('click', async () => {
      arciumOn = !arciumOn;
      const toggle = document.getElementById('arciumToggle');
      toggle.classList.toggle('on', arciumOn);
      const statusEl = document.getElementById('arciumStatus');
      if (arciumOn) {
        await checkArciumStatus();
      } else {
        arciumReady = false;
        statusEl.className = 'arcium-status';
        statusEl.textContent = 'Off — local encoding';
      }
    });

    fetchArciumInfo();

    document.querySelectorAll('.tab').forEach(t => {
      t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById(t.dataset.tab).classList.add('active');
      });
    });

    document.getElementById('encodeMode').addEventListener('change', e => {
      const v = e.target.value;
      document.getElementById('encodePassword').style.display = v === 'secure' ? 'block' : 'none';
      document.getElementById('encodeSplitKeyInfo').style.display = v === 'splitkey' ? 'block' : 'none';
    });

    document.getElementById('decodeMode').addEventListener('change', e => {
      const v = e.target.value;
      document.getElementById('decodePassword').style.display = v === 'secure' ? 'block' : 'none';
      document.getElementById('decodeSplitKeyWrap').style.display = v === 'splitkey' ? 'block' : 'none';
    });

    document.getElementById('decodeK2Source').addEventListener('change', e => {
      const paste = document.getElementById('decodeK2Paste');
      const escrow = document.getElementById('decodeK2Escrow');
      if (e.target.value === 'paste') {
        paste.style.display = 'block';
        escrow.style.display = 'none';
      } else {
        paste.style.display = 'none';
        escrow.style.display = 'block';
      }
    });

    document.getElementById('plasmidMode').addEventListener('change', e => {
      const v = e.target.value;
      document.getElementById('plasmidPassword').style.display = v === 'secure' ? 'block' : 'none';
      document.getElementById('plasmidSplitKeyInfo').style.display = v === 'splitkey' ? 'block' : 'none';
    });

    document.getElementById('plasmidExpressionMode').addEventListener('change', e => {
      document.getElementById('plasmidExpressionOptions').style.display =
        e.target.checked ? 'block' : 'none';
    });

    let plasmidViewer = null;
    let plasmidDesign = null;

    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function wrapSequence(seq, lineLen) {
      lineLen = lineLen || 80;
      let out = '';
      for (let i = 0; i < seq.length; i += lineLen) {
        out += seq.slice(i, i + lineLen) + '\n';
      }
      return out.trim();
    }

    function buildPlasmidSequence(payload, expressionMode, hasFluorescence) {
      if (!expressionMode) return payload;
      let seq = PLASMID_PARTS.markerStart + payload + PLASMID_PARTS.markerEnd;
      if (hasFluorescence) {
        seq += PLASMID_PARTS.promoter + PLASMID_PARTS.rbs + PLASMID_PARTS.egfp + PLASMID_PARTS.terminator;
      }
      return seq;
    }

    function buildPlasmidAnnotations(payload, expressionMode, hasFluorescence) {
      const ann = [];
      let pos = 0;
      if (expressionMode) {
        ann.push({ start: pos, end: pos + PLASMID_PARTS.markerStart.length, name: 'Marker Start', direction: 1 });
        pos += PLASMID_PARTS.markerStart.length;
      }
      ann.push({ start: pos, end: pos + payload.length, name: 'Payload', direction: 1 });
      pos += payload.length;
      if (expressionMode) {
        ann.push({ start: pos, end: pos + PLASMID_PARTS.markerEnd.length, name: 'Marker End', direction: 1 });
        pos += PLASMID_PARTS.markerEnd.length;
        if (hasFluorescence) {
          ann.push({ start: pos, end: pos + PLASMID_PARTS.promoter.length, name: 'Promoter', direction: 1 });
          pos += PLASMID_PARTS.promoter.length;
          ann.push({ start: pos, end: pos + PLASMID_PARTS.rbs.length, name: 'RBS', direction: 1 });
          pos += PLASMID_PARTS.rbs.length;
          ann.push({ start: pos, end: pos + PLASMID_PARTS.egfp.length, name: 'eGFP', direction: 1 });
          pos += PLASMID_PARTS.egfp.length;
          ann.push({ start: pos, end: pos + PLASMID_PARTS.terminator.length, name: 'Terminator', direction: 1 });
        }
      }
      return ann;
    }

    document.getElementById('plasmidBtn').addEventListener('click', async () => {
      const msg = document.getElementById('plasmidInput').value.trim();
      const mode = document.getElementById('plasmidMode').value;
      const password = document.getElementById('plasmidPass').value;
      const name = document.getElementById('plasmidName').value.trim() || 'biocypher_plasmid';
      const expressionMode = document.getElementById('plasmidExpressionMode').checked;
      const hasFluorescence = expressionMode && document.getElementById('plasmidFluorescence').checked;
      const out = document.getElementById('plasmidOutput');
      const viewerWrap = document.getElementById('plasmidViewerWrap');
      const exportRow = document.getElementById('plasmidExportRow');

      if (!msg) { out.textContent = 'Enter a message'; out.classList.add('error'); out.style.display = 'block'; return; }
      if (mode === 'secure' && !password) { out.textContent = 'Password required for secure mode'; out.classList.add('error'); out.style.display = 'block'; return; }

      out.classList.remove('error', 'success');
      out.style.display = 'block';
      out.textContent = 'Designing...';
      try {
        const body = { message: msg, mode };
        if (mode === 'secure') body.password = password;
        const r = await fetch(API + '/api/encode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if (!r.ok) {
          out.textContent = j.error || JSON.stringify(j);
          out.classList.add('error');
          return;
        }
        const payload = j.dna_sequence;
        const fullSequence = buildPlasmidSequence(payload, expressionMode, hasFluorescence);
        const payloadStart = expressionMode ? PLASMID_PARTS.markerStart.length : 0;
        const payloadEnd = payloadStart + payload.length;

        plasmidDesign = {
          name,
          sequence: fullSequence,
          payload,
          mode,
          message_length: msg.length,
          gc_content: j.stats?.gc_content ?? 0,
          created: new Date().toISOString(),
          structure: expressionMode ? 'expression' : 'simple',
          hasFluorescence: !!hasFluorescence,
          hasMarkers: !!expressionMode,
          payloadStart,
          payloadEnd,
          k1_base64: j.k1_base64 || null,
          k2_base64: j.k2_base64 || null,
          transmission_id: j.transmission_id || null
        };

        const seqInfo = fullSequence.length + ' bases' + (expressionMode ? ' (payload: ' + payload.length + ')' : '') + ', GC: ' + (j.stats?.gc_content ?? 0) + '%';
        out.textContent = fullSequence + '\n\n' + seqInfo;
        out.classList.add('success');

        viewerWrap.classList.remove('hidden');
        exportRow.classList.remove('hidden');

        const splitKeyActions = document.getElementById('plasmidSplitKeyActions');
        if (mode === 'splitkey' && j.k1_base64) {
          splitKeyActions.classList.remove('hidden');
        } else {
          splitKeyActions.classList.add('hidden');
        }

        const viewerEl = document.getElementById('plasmidViewer');
        const annotations = buildPlasmidAnnotations(payload, expressionMode, hasFluorescence);
        if (typeof seqviz !== 'undefined' && seqviz && seqviz.Viewer) {
          try {
            if (plasmidViewer) {
              plasmidViewer.setState({ seq: fullSequence, name, annotations });
            } else {
              viewerEl.innerHTML = '';
              plasmidViewer = seqviz.Viewer(viewerEl, {
                seq: fullSequence,
                name,
                viewer: 'both',
                showComplement: true,
                annotations,
                style: { height: '400px', width: '100%' }
              });
              plasmidViewer.render();
            }
          } catch (e) {
            viewerEl.innerHTML = '<pre class="output" style="margin:0;padding:1rem">' + fullSequence + '</pre>';
          }
        } else {
          viewerEl.innerHTML = '<pre class="output" style="margin:0;padding:1rem">' + fullSequence + '</pre>';
        }
      } catch (e) {
        out.textContent = 'Error: ' + e.message + '\n\nIs the server running? (cargo run)';
        out.classList.add('error');
      }
    });

    document.getElementById('exportFastaBtn').addEventListener('click', () => {
      if (!plasmidDesign) return;
      const fasta = '>' + plasmidDesign.name + '\n' + wrapSequence(plasmidDesign.sequence);
      downloadFile(fasta, plasmidDesign.name + '.fasta', 'text/plain');
    });

    document.getElementById('exportTxtBtn').addEventListener('click', () => {
      if (!plasmidDesign) return;
      downloadFile(plasmidDesign.sequence, plasmidDesign.name + '.txt', 'text/plain');
    });

    document.getElementById('exportInstructionsBtn').addEventListener('click', () => {
      if (!plasmidDesign) return;
      const json = JSON.stringify(plasmidDesign, null, 2);
      downloadFile(json, plasmidDesign.name + '_instructions.json', 'application/json');
    });

    document.getElementById('screenPlasmidBtn').addEventListener('click', async () => {
      if (!plasmidDesign) return;
      const out = document.getElementById('plasmidOutput');
      out.classList.remove('error', 'success');
      out.style.display = 'block';
      out.textContent = 'Screening...';
      try {
        const r = await fetch(API + '/api/safety-screen', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dna_sequence: plasmidDesign.sequence })
        });
        const j = await r.json();
        if (!r.ok) {
          out.textContent = j.error || JSON.stringify(j);
          out.classList.add('error');
          return;
        }
        let s = 'Status: ' + j.safety_status + ' ' + (j.safety_icon || '') + '\n';
        s += 'GC content: ' + (j.sequence_characteristics?.gc_content || 'N/A') + '%\n';
        if (j.recommendations?.length) s += '\nRecommendations: ' + j.recommendations.join('\n');
        out.textContent = s;
        out.classList.add('success');
      } catch (e) {
        out.textContent = 'Error: ' + e.message + '\n\nServer required for safety screen. Is it running? (cargo run)';
        out.classList.add('error');
      }
    });

    async function deriveKey(password, salt) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits']);
      const bits = await crypto.subtle.deriveBits({ name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' }, keyMaterial, 256);
      return crypto.subtle.importKey('raw', bits, { name: 'AES-GCM' }, false, ['encrypt']);
    }

    async function encryptPayload(plaintext, password) {
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(password, salt);
      const enc = new TextEncoder();
      const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(plaintext));
      const blob = new Uint8Array(salt.length + iv.length + ct.byteLength);
      blob.set(salt, 0);
      blob.set(iv, 16);
      blob.set(new Uint8Array(ct), 28);
      return { encrypted: btoa(String.fromCharCode(...blob)) };
    }

    document.getElementById('saveK1Btn').addEventListener('click', () => {
      if (!plasmidDesign || !plasmidDesign.k1_base64) return;
      downloadFile(plasmidDesign.k1_base64, 'k1_' + (plasmidDesign.transmission_id || 'key') + '.txt', 'text/plain');
    });

    document.getElementById('escrowK2Btn').addEventListener('click', async () => {
      if (!plasmidDesign || !plasmidDesign.k2_base64 || !plasmidDesign.transmission_id) return;
      const out = document.getElementById('transmitOutput');
      out.style.display = 'block';
      out.textContent = 'Storing K2 in escrow...';
      try {
        const r = await fetch(ARCIUM_URL + '/escrow-store', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            transmission_id: plasmidDesign.transmission_id,
            k2: plasmidDesign.k2_base64
          })
        });
        const j = await r.json();
        if (!r.ok) {
          out.textContent = j.error || JSON.stringify(j);
          out.classList.add('error');
          return;
        }
        out.textContent = 'K2 stored in escrow. Transmission ID: ' + plasmidDesign.transmission_id;
        out.classList.remove('error');
        out.classList.add('success');
      } catch (e) {
        out.textContent = 'Error: ' + e.message + '\n\nIs the Arcium service running?';
        out.classList.add('error');
      }
    });

    document.getElementById('transmitBtn').addEventListener('click', () => {
      if (!plasmidDesign) return;
      const isSplitKey = plasmidDesign.mode === 'splitkey';
      if (!isSplitKey && (!arciumOn || !arciumReady)) {
        alert('Connect Arcium MPC first (toggle on and wait for connection) to use secure transmission.');
        return;
      }
      document.getElementById('transmitSecureWrap').style.display = isSplitKey ? 'none' : 'block';
      document.getElementById('transmitSplitKeyNote').style.display = isSplitKey ? 'block' : 'none';
      document.getElementById('transmitConfirmBtn').textContent = isSplitKey ? 'Send to manufacturer' : 'Send encrypted transmission';
      document.getElementById('plasmidTransmitWrap').classList.toggle('hidden');
    });

    document.getElementById('transmitConfirmBtn').addEventListener('click', async () => {
      const manufacturerUrl = document.getElementById('transmitManufacturerUrl').value.trim();
      const out = document.getElementById('transmitOutput');
      if (!plasmidDesign) return;
      const isSplitKey = plasmidDesign.mode === 'splitkey';
      if (!isSplitKey) {
        const password = document.getElementById('transmitPassword').value;
        if (!password) {
          out.textContent = 'Enter a transmission password (share with manufacturer for decryption).';
          out.classList.add('error');
          out.style.display = 'block';
          return;
        }
      }
      out.classList.remove('error', 'success');
      out.style.display = 'block';
      out.textContent = isSplitKey ? 'Transmitting...' : 'Encrypting and transmitting...';
      try {
        const fasta = '>' + plasmidDesign.name + '\n' + wrapSequence(plasmidDesign.sequence);
        if (isSplitKey) {
          const body = { fasta, instructions: plasmidDesign };
          if (manufacturerUrl) body.manufacturer_url = manufacturerUrl;
          const r = await fetch(ARCIUM_URL + '/transmit-split-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const j = await r.json();
          if (!r.ok) {
            out.textContent = j.error || JSON.stringify(j);
            out.classList.add('error');
            return;
          }
          out.textContent = (j.message || 'Transmission sent.') + (j.transmission_id ? '\n\nID: ' + j.transmission_id : '');
          out.classList.add('success');
        } else {
          const payload = JSON.stringify({ fasta, instructions: plasmidDesign });
          const { encrypted } = await encryptPayload(payload, document.getElementById('transmitPassword').value);
          const body = { encrypted };
          if (manufacturerUrl) body.manufacturer_url = manufacturerUrl;
          const r = await fetch(ARCIUM_URL + '/transmit-secure', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const j = await r.json();
          if (!r.ok) {
            out.textContent = j.error || JSON.stringify(j);
            out.classList.add('error');
            return;
          }
          out.textContent = (j.message || 'Transmission sent.') + (j.transmission_id ? '\n\nID: ' + j.transmission_id : '');
          out.classList.add('success');
        }
      } catch (e) {
        out.textContent = 'Error: ' + e.message + '\n\nIs the Arcium service running?';
        out.classList.add('error');
      }
    });

    document.getElementById('encodeBtn').addEventListener('click', async () => {
      const msg = document.getElementById('encodeInput').value.trim();
      const mode = document.getElementById('encodeMode').value;
      const password = document.getElementById('encodePass').value;
      const out = document.getElementById('encodeOutput');

      if (!msg) { out.textContent = 'Enter a message'; out.classList.add('error'); out.style.display = 'block'; return; }
      if (mode === 'secure' && !password) { out.textContent = 'Password required for secure mode'; out.classList.add('error'); out.style.display = 'block'; return; }
      if (arciumOn && !arciumReady && mode !== 'splitkey') { out.textContent = 'Connect to Arcium first (toggle on and wait for connection)'; out.classList.add('error'); out.style.display = 'block'; return; }
      if (arciumOn && msg.length > 4 && mode !== 'splitkey') { out.textContent = 'Arcium MPC supports max 4 characters. Use local encode for longer messages.'; out.classList.add('error'); out.style.display = 'block'; return; }

      out.classList.remove('error', 'success');
      try {
        if (arciumOn && mode !== 'splitkey') {
          const r = await fetch(ARCIUM_URL + '/encode-mpc', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg })
          });
          const j = await r.json();
          if (!r.ok) { out.textContent = j.error || JSON.stringify(j); out.classList.add('error'); }
          else {
            out.textContent = j.dna_sequence + (j.stats ? '\n\n' + j.stats.length + ' bases, GC: ' + j.stats.gc_content + '%\n\n(Arcium MPC)' : '');
            out.classList.add('success');
          }
        } else {
          const body = { message: msg, mode };
          if (mode === 'secure') body.password = password;
          if (document.getElementById('encodeStoreOnChain').checked) body.store_on_chain = true;
          const r = await fetch(API + '/api/encode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const j = await r.json();
          if (!r.ok) { out.textContent = j.error || JSON.stringify(j); out.classList.add('error'); }
          else {
            let txt = j.dna_sequence + (j.stats ? '\n\n' + j.stats.length + ' bases, GC: ' + j.stats.gc_content + '%' : '');
            if (j.transaction_signature) txt += '\n\nAttested on Solana: ' + j.transaction_signature + '\nhttps://explorer.solana.com/tx/' + j.transaction_signature + '?cluster=devnet';
            if (mode === 'splitkey' && j.k1_base64) txt += '\n\n[Split Key] Save K1 securely. Escrow K2 via plasmid tab or POST /escrow-store. Transmission ID: ' + (j.transmission_id || '');
            out.textContent = txt;
            out.classList.add('success');
          }
        }
      } catch (e) {
        out.textContent = 'Error: ' + e.message + '\n\n' + (arciumOn ? 'Is the Arcium service running?' : 'Is the server running? (cargo run)');
        out.classList.add('error');
      }
      out.style.display = 'block';
    });

    document.getElementById('decodeBtn').addEventListener('click', async () => {
      let seq = document.getElementById('decodeInput').value.trim().replace(/\s/g, '');
      const mode = document.getElementById('decodeMode').value;
      const password = document.getElementById('decodePass').value;
      const extractPayload = document.getElementById('decodeExtractPayload').checked;
      const out = document.getElementById('decodeOutput');

      if (!seq) { out.textContent = 'Enter a DNA sequence'; out.classList.add('error'); out.style.display = 'block'; return; }
      if (mode === 'secure' && !password) { out.textContent = 'Password required for secure mode'; out.classList.add('error'); out.style.display = 'block'; return; }
      if (mode === 'splitkey') {
        const k1 = document.getElementById('decodeK1').value.trim();
        const k2Source = document.getElementById('decodeK2Source').value;
        const k2Paste = document.getElementById('decodeK2').value.trim();
        const transmissionId = document.getElementById('decodeTransmissionId').value.trim();
        if (!k1) { out.textContent = 'Enter K1 (base64)'; out.classList.add('error'); out.style.display = 'block'; return; }
        if (k2Source === 'paste' && !k2Paste) { out.textContent = 'Enter K2 (base64)'; out.classList.add('error'); out.style.display = 'block'; return; }
        if (k2Source === 'escrow' && !transmissionId) { out.textContent = 'Enter transmission ID to fetch K2 from escrow'; out.classList.add('error'); out.style.display = 'block'; return; }
      }

      if (extractPayload) {
        const seqUpper = seq.toUpperCase();
        const mStart = PLASMID_PARTS.markerStart.toUpperCase();
        const mEnd = PLASMID_PARTS.markerEnd.toUpperCase();
        const iStart = seqUpper.indexOf(mStart);
        const iEnd = seqUpper.indexOf(mEnd);
        if (iStart === -1 || iEnd === -1) {
          out.textContent = 'Markers not found. Paste full plasmid or uncheck "Extract payload".';
          out.classList.add('error');
          out.style.display = 'block';
          return;
        }
        const payloadStart = iStart + mStart.length;
        const payloadEnd = iEnd;
        if (payloadStart >= payloadEnd) {
          out.textContent = 'Invalid marker order. Check sequence.';
          out.classList.add('error');
          out.style.display = 'block';
          return;
        }
        seq = seq.slice(payloadStart, payloadEnd);
      }

      if (arciumOn && mode !== 'splitkey' && !arciumReady) { out.textContent = 'Connect to Arcium first (toggle on and wait for connection)'; out.classList.add('error'); out.style.display = 'block'; return; }
      if (arciumOn && mode !== 'splitkey' && seq.length !== 16) { out.textContent = 'Arcium MPC requires exactly 16 DNA bases.'; out.classList.add('error'); out.style.display = 'block'; return; }

      out.classList.remove('error', 'success');
      try {
        let k2Base64 = null;
        if (mode === 'splitkey') {
          const k2Source = document.getElementById('decodeK2Source').value;
          if (k2Source === 'escrow') {
            const transmissionId = document.getElementById('decodeTransmissionId').value.trim();
            const rEscrow = await fetch(ARCIUM_URL + '/escrow-retrieve', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ transmission_id: transmissionId })
            });
            const jEscrow = await rEscrow.json();
            if (!rEscrow.ok) {
              out.textContent = 'Escrow error: ' + (jEscrow.error || JSON.stringify(jEscrow));
              out.classList.add('error');
              out.style.display = 'block';
              return;
            }
            k2Base64 = jEscrow.k2;
          } else {
            k2Base64 = document.getElementById('decodeK2').value.trim();
          }
        }
        if (arciumOn && mode !== 'splitkey') {
          const r = await fetch(ARCIUM_URL + '/decode-mpc', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sequence: seq })
          });
          const j = await r.json();
          if (!r.ok) { out.textContent = j.error || JSON.stringify(j); out.classList.add('error'); }
          else {
            out.textContent = j.decoded_message + '\n\n(Arcium MPC)';
            out.classList.add('success');
          }
        } else {
          const body = { sequence: seq, mode };
          if (mode === 'secure') body.password = password;
          if (mode === 'splitkey') {
            body.k1_base64 = document.getElementById('decodeK1').value.trim();
            body.k2_base64 = k2Base64;
          }
          if (document.getElementById('decodeOnChain').checked) body.decode_on_chain = true;
          const r = await fetch(API + '/api/decode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const j = await r.json();
          if (!r.ok) { out.textContent = j.error || JSON.stringify(j); out.classList.add('error'); }
          else {
            let txt = j.decoded_message;
            if (j.transaction_signature) txt += '\n\nRecorded on Solana: ' + j.transaction_signature + '\nhttps://explorer.solana.com/tx/' + j.transaction_signature + '?cluster=devnet';
            out.textContent = txt;
            out.classList.add('success');
          }
        }
      } catch (e) {
        out.textContent = 'Error: ' + e.message + '\n\n' + (arciumOn ? 'Is the Arcium service running?' : 'Is the server running? (cargo run)');
        out.classList.add('error');
      }
      out.style.display = 'block';
    });

    document.getElementById('safetyBtn').addEventListener('click', async () => {
      const seq = document.getElementById('safetyInput').value.trim().replace(/\s/g, '');
      const out = document.getElementById('safetyOutput');

      if (!seq) { out.textContent = 'Enter a DNA sequence'; out.classList.add('error'); out.style.display = 'block'; return; }

      out.classList.remove('error', 'success');
      try {
        const body = { dna_sequence: seq };
        if (document.getElementById('safetyVerifyOnChain').checked) body.verify_on_chain = true;
        const r = await fetch(API + '/api/safety-screen', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if (!r.ok) { out.textContent = j.error || JSON.stringify(j); out.classList.add('error'); }
        else {
          let s = 'Status: ' + j.safety_status + ' ' + (j.safety_icon || '') + '\n';
          s += 'GC content: ' + (j.sequence_characteristics?.gc_content || 'N/A') + '%\n';
          if (j.recommendations?.length) s += '\nRecommendations: ' + j.recommendations.join('\n');
          if (j.transaction_signature) s += '\n\nVerified on Solana: ' + j.transaction_signature + '\nhttps://explorer.solana.com/tx/' + j.transaction_signature + '?cluster=devnet';
          out.textContent = s;
          out.classList.add('success');
        }
      } catch (e) {
        out.textContent = 'Error: ' + e.message + '\n\nIs the server running? (cargo run)';
        out.classList.add('error');
      }
      out.style.display = 'block';
    });
  </script>
</body>
</html>
